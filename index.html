<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="utf-8" />

    <title>How to develop in PHP with Docker and Docker Compose</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <meta name="description" content="Development in PHP with Docker" />
    <meta name="author" content="Damien Carcel" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
    />
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <section id="presentation-title">
          <h2>Developing in PHP<br />with Docker and Docker Compose</h2>

          <br />
          <br />

          <h3>Damien Carcel</h3>
        </section>

        <section id="plan">
          <section>
            <h2>What will we see?</h2>

            <div class="centered-slide-content">
              <ul>
                <li>Presentation of Docker</li>
                <li>How to use Docker</li>
                <li>Docker Compose</li>
                <li>Running and Debugging with PHPStorm</li>
              </ul>
            </div>

            <aside class="notes">
              We will not use the Symfony CLI tool and its built-in server, only pure PHP, as I want to keep things
              simple.
            </aside>
          </section>
        </section>

        <section id="presentation">
          <section>
            <h2>What is (not) Docker?</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">Docker is not a virtual machine (VM)</li>
              </ul>

              <br />

              <img alt="virtualization.svg" src="images/virtualization.svg" class="fragment" />
            </div>

            <aside class="notes">A VM runs a full operating system on virtualized hardware.</aside>
          </section>

          <section>
            <h2>A Container Orchestrator</h2>

            <div class="centered-slide-content">
              <img alt="vms_vs_containers.jpg" src="images/vms_vs_containers.jpg" />
              <p>Virtual machines vs. containers</p>
            </div>

            <aside class="notes">
              <p>Containers remove the hardware virtualization and the guest OS.</p>
              <p>The Docker engine has access to the real hardware and uses the host Linux kernel.</p>
              <p>Except on macOS and Windows, as Docker runs in a VM providing a GNU/Linux OS.</p>
            </aside>
          </section>

          <section>
            <h2>How does it works</h2>

            <div class="centered-slide-content">
              <img alt="docker_components.png" src="images/docker_components.png" />
              <p>Docker components</p>
            </div>

            <aside class="notes">
              <p>The docker command is only a client talking to the engine.</p>
              <p>The Docker engine is a high level abstraction talking with containerd.</p>
              <p>
                containerd contains all the services to manage images, volumes, snapshots, etc‚Ä¶, including a client for
                shim
              </p>
              <p>shim can be seen as an API to talk the runtime.</p>
              <p>
                runc is the container runtime, and can in fact be called directly, but it is very cumbersome to do so.
              </p>
              <p>Other engines and/or other runtime can be used.</p>
            </aside>
          </section>

          <section>
            <h2>How does it works</h2>

            <div class="centered-slide-content">
              <h3>Docker specificity</h3>
              <ul>
                <li class="fragment">Dockerfile ‚Üí Image ‚Üí Containers</li>
                <li class="fragment">Only one process in the container</li>
              </ul>
            </div>

            <aside class="notes">
              <p>
                Images built from the Dockerfile follow the
                <a href="https://opencontainers.org/">Open Container Initiative</a> specifications.
              </p>
            </aside>
          </section>

          <section>
            <h2>A Dockerfile example</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile">
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get --no-install-recommends --no-install-suggests install php && \
    apt-get clean && \
    apt-get autoremove --purge && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
            /usr/share/doc/* /usr/share/groff/* \
            /usr/share/info/* /usr/share/linda/* \
            /usr/share/lintian/* /usr/share/locale/* \
            /usr/share/man/*

              </code></pre>
            </div>

            <aside class="notes">
              Explain the concept of layers. Details will be explained in the "Advanced" section.
            </aside>
          </section>
        </section>

        <section id="using-docker">
          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <img src="images/docker.png" />
            </div>

            <aside class="notes">
              <!-- -->
            </aside>
          </section>

          <section>
            <h2>Using Docker</h2>

            <div class="centered-slide-content">
              <h3>The Very Basics</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Invoking the Docker CLI</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker
              </code></pre>
            </div>

            <aside class="notes">
              <p>Present briefly the various Docker available commands</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Pulling an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">Pull the latest Debian &ldquo;slim&rdquo; image</li>
                <li class="fragment" data-fragment-index="4">List the pulled images</li>
              </ul>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker image pull debian:bookworm-slim
              </code></pre>
              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker image pull debian:12-slim
              </code></pre>

              <pre class="fragment" data-fragment-index="5"><code class="shell">
$ docker image ls
            </code></pre>
            </div>

            <aside class="notes">
              <p>Explain "pull" and the tag system</p>
              <p>Explain the layers</p>
              <p>"docker image ls" same thing that "docker images"</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Going a bit further with Images</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">Inspect an image</li>
                <li class="fragment" data-fragment-index="3">Display the history</li>
              </ul>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker image inspect debian:bookworm-slim
$ docker image inspect debian:12-slim
              </code></pre>

              <pre class="fragment" data-fragment-index="4"><code class="shell">
$ docker image history debian:bookworm-slim
             </code></pre>
            </div>

            <aside class="notes">
              <p>Two tags but same layers, so stored only once ‚Üí no disk space wasted</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Running a container</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="1">Use bash in a container</li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="2">
                You need to be able to fully interact with the console inside your container
              </div>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker container run debian:stable-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Basic run example</legend>
            </div>

            <aside class="notes">
              <p>Not mandatory to run, but funny</p>
              <p>Before image name: options; after image name: command that will run in the container</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Running a container</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="shell">
$ docker container run -i -t --rm debian:stable-slim bash
              </code></pre>
            </div>

            <aside class="notes">
              <p>docker container ls -a shows stopped containers</p>
              <p>`--rm` is a must-use</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker</h2>

            <div class="centered-slide-content">
              <h3>Going Further</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">
                  <code class="shell inline-code">docker container run --env</code> can create variables inside the
                  container
                </li>
                <li class="fragment">It will override the value if the variable already exist</li>
              </ul>

              <pre class="fragment"><code class="dockerfile">
FROM scratch

ENV MY_VAR="A value"
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="practice-time">Export an environment variable in your terminal</li>
                <li class="fragment practice-time" data-fragment-index="1">
                  Display its value from a container through <code class="shell inline-code">docker container run</code>
                </li>
              </ul>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container run -e VARIABLE_NAME="value" debian:stable-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Create the environment variable "VARIABLE_NAME"</legend>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <h3>Solutions</h3>

              <pre><code class="shell">
$ export HOST_VAR="Hello\!"
$ docker container run -e CONTAINER_VAR=$HOST_VAR debian:stable-slim \
    sh -c 'echo $CONTAINER_VAR'
              </code></pre>

              <div class="fragment" data-fragment-index="1">or</div>

              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ export MY_VAR="Hello\!"
$ docker container run -e MY_VAR debian:stable-slim sh -c 'echo $MY_VAR'
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <div class="fragment">Two usages</div>

              <br />
              <br />

              <ul>
                <li class="fragment">Volumes allow to persist data outside the container</li>
                <li class="fragment">Bind-mount allow sharing data between the host and the container</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile">
FROM scratch

VOLUME /data
              </code></pre>
              <legend>Expose <span class="inline-code">/data</span> as a volume</legend>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ docker container run -v /path-on-host:/path-in-container debian:stable-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="1">
                Bind mount a volume or a folder/file from your host inside the container
              </legend>
            </div>

            <aside class="notes">
              <p>Show an example by running a MySQL container and inspect the volume to find its path</p>
              <p>Bind mount: always host path first, then container path</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="1">Create a named volume</li>
                <li class="fragment practice-time" data-fragment-index="2">
                  Run a container while bind-mounting the volume into <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-time" data-fragment-index="3">
                  Create a file in <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-time" data-fragment-index="4">
                  Stop the container and ensure it is removed
                </li>
                <li class="fragment practice-time" data-fragment-index="5">
                  Find on your host the file you just created in the container
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="6">Tips</div>
              <ul class="fragment" data-fragment-index="6">
                <li>Look at what the <code class="inline-code">docker volume</code> management command propose</li>
                <li>
                  Bind mount through<br />
                  <code class="inline-code">docker container run -v host-data:container-data</code>
                </li>
              </ul>
            </div>

            <aside class="notes">
              <p>Most of the major management commands propose `inspect`</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre><code class="shell">
$ docker volume create keep-my-data
$ docker container run -i -t --rm -v keep-my-data:/data debian:stable-slim bash

### Now I am in the container ###

$ echo "This is a test" > /data/test.txt

### CTRL+D to exit ###

$ docker volume inspect keep-my-data
$ sudo cat /the/path/to/the/data/shown/by/the/inspection/of/the/volume/test.txt

### Should display "This is a test" ###
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="practice-time">
                  Run a container while bind-mounting<br />
                  <code class="inline-code">/home/&lt;your login&gt;/Downloads/test</code> into
                  <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-time">Create a file in <code class="inline-code">/data</code></li>
                <li class="fragment practice-time">Stop the container and ensure it is removed</li>
                <li class="fragment practice-time">
                  Try to edit on your host the file you just created in the container with your favorite text editor
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre><code class="shell">
$ docker container run -i -t --rm \
    -v /home/&lt;your login&gt;/Downloads:/data debian:stable-slim bash

### Now I am in the container ###

$ echo "This is a test" > /data/test.txt

### CTRL+D to exit ###

$ vim /home/&lt;your login&gt;/Downloads/test.txt

### Will fail because of a permission problem, ###
### because we were "root" in the container ###
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">
                  <code class="shell inline-code">docker container run --user</code> allows to specify a user inside the
                  container
                </li>
                <li class="fragment" data-fragment-index="2">
                  It will override any user already specified as default in the Dockerfile
                </li>
              </ul>

              <pre class="fragment" data-fragment-index="3"><code class="dockerfile">
FROM an-image-with-user:michel

USER root

RUN apt install something

USER michel
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Define a current user directly in the container</legend>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="2">
                  Again, run a container while bind-mounting, but this time specify a user
                  <code class="inline-code">/home/&lt;your login&gt;/Downloads/test</code> into
                  <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-time" data-fragment-index="3">
                  Create a file in <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-time" data-fragment-index="4">
                  Stop the container and ensure it is removed
                </li>
                <li class="fragment practice-time" data-fragment-index="5">
                  Goal: editing the file you just created in the container should work
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="shell">
$ docker container run -i -t --rm \
    -u $(id -u):$(id -g) \
    -v /home/&lt;your login&gt;/Downloads:/data debian:stable-slim bash
              </code></pre>
            </div>

            <aside class="notes">
              <p>
                You could also extend the image in a Dockerfile, create a user, and use this user as default or through
                `--user`
              </p>
              <p>IMPORTANT: `-u user` ‚Üí "user" is the user in the container, not on your host</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - One last thing</h2>

            <div class="centered-slide-content">
              <div class="fragment practice-time" data-fragment-index="1">Try to run the following:</div>
              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ docker container run -i -t --rm \
    -u $(id -u):$(id -g) \
    -v /home/&lt;your login&gt;/Downloads/test:/data debian:stable-slim bash
              </code></pre>

              <br />
              <br />

              <div class="fragment practice-time" data-fragment-index="2">
                Look on your host. Can you say what is wrong?
              </div>
            </div>

            <aside class="notes">
              You could also extend the image in a Dockerfile, create a user, and use this user as default or through
              `--user`
            </aside>
          </section>

          <section>
            <h2>Using Docker</h2>

            <div class="centered-slide-content">
              <h3>Let's create and serve a Symfony app</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Create a Symfony app</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="1">
                  Use the <code class="inline-code">composer:latest</code> Docker image to create a Symfony app
                </li>
                <li class="fragment practice-time" data-fragment-index="2">
                  <code class="inline-code">/home/&lt;your login&gt;/training/composer/config</code> on your host
                </li>
                <li class="fragment practice-time" data-fragment-index="2">
                  <code class="inline-code">/tmp/composer/config</code> inside the container
                </li>
                <li class="fragment practice-time" data-fragment-index="3">
                  <code class="inline-code">/home/&lt;your login&gt;/training/composer/cache</code> on your host
                </li>
                <li class="fragment practice-time" data-fragment-index="3">
                  <code class="inline-code">/tmp/composer/cache</code> inside the container
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="6">Tips</div>
              <ul class="fragment" data-fragment-index="6">
                <li><code class="inline-code">composer create-project symfony/skeleton my-app</code></li>
                <li><code class="inline-code">COMPOSER_HOME="/path/to/config"</code></li>
                <li><code class="inline-code">COMPOSER_CACHE_DIR="/path/to/cache"</code></li>
                <li>You need to specify the "working directory" where to create the app</li>
              </ul>
            </div>

            <aside class="notes">
              <p>We didn't see the working directory notion yet</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Create a Symfony app</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="shell">
$ mkdir -p training/composer/config training/composer/cache training/workspace

$ docker container run -i -t --rm \
    -u $(id -u):$(id -g) \
    -e COMPOSER_HOME="/tmp/composer/config" \
    -v /home/&lt;your login&gt;/training/composer/config:/tmp/composer/config \
    -e COMPOSER_CACHE_DIR="/tmp/composer/cache" \
    -v /home/&lt;your login&gt;/training/composer/cache:/tmp/composer/cache \
    -w /data \
    -v /home/&lt;your login&gt;/training/workspace:/data \
    composer:latest composer create-project symfony/skeleton my-app
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Serve a Symfony app</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="1">
                  Serve and expose the app on port <code class="inline-code">8080</code>
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="2">Tips</div>
              <ul class="fragment" data-fragment-index="2">
                <li><code class="inline-code">php -S 0.0.0.0:8000 -t public</code></li>
                <li>
                  Look at the "publish" <code class="inline-code">-p</code> option of
                  <code class="inline-code">docker container run</code>
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Serve a Symfony app</h2>

            <div class="centered-slide-content">
              <h3>Solutions</h3>

              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 \
    -p 8080:8000 \
    -w /data -v /home/damien/training/workspace/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 -d \
    -p 8080:8000 \
    -w /data -v /home/damien/training/workspace/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>
            </div>

            <aside class="notes">
              <p>Like for the volumes, the first port is on the host, the second in the container</p>
              <p>"Detached" mode gives you the terminal back right away</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Display logs</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">Run the app in "detached" mode</li>
              </ul>

              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 -d --name my-app-container \
    -p 8080:8000 \
    -w /data -v /home/damien/training/workspace/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container logs my-app-container
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container logs -f --tail 1 my-app-container
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Manipulate a detached container</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker container exec -i -t my-app-container bash
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container stop my-app-container
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Container isolation</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 -d --name my-app-container \
    -w /data -v /home/damien/training/workspace/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>

              <ul>
                <li class="fragment">Could we access this app from another container?</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Container isolation</h2>

            <div class="centered-slide-content">
              <h3>Yes, you can</h3>

              <pre class="fragment"><code class="shell">
$ docker container inspect
### Retrieve the IP address ###
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container run -i -t --rm curlimages/curl curl &lt;IP address&gt;:8000
### Will display Symfony dev page ###
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker network create my-network
$ docker container run -i -t --rm --network my-network \
    curlimages/curl curl 172.17.0.2:8000
### There, you cannot ###
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker</h2>

            <div class="centered-slide-content">
              <h3>Building custom images</h3>
              <div class="fragment">Now you can use your IDE üíª</div>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="dockerfile">
FROM some-image:image-tag
              </code></pre>
              <legend class="fragment" data-fragment-index="1">The most basic Dockerfile you can write</legend>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker image build --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>Present "builder" management command and "buildx" plugin.</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content" data-line-numbers="3">
              <pre><code class="dockerfile" data-line-numbers="3|3-5|3-6">

FROM some-image:image-tag

ARG MY_ARG = "A environment variable only available at build time"
ENV MY_VAR = "A environment variable that will stay at runtime"
              </code></pre>
              <legend>Environment variables and arguments</legend>

              <pre class="fragment"><code class="shell">
$ docker image build --build-arg MY_ARG="An overriding value" --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content" data-line-numbers="3">
              <pre><code class="dockerfile" data-trim data-line-numbers="1-3">
ARG IMAGE_TAG

FROM some-image:${IMAGE_TAG}

ARG MY_ARG="A environment variable only available at build time"
ENV MY_VAR="A environment variable that will stay at runtime"
              </code></pre>
              <legend>Environment variables and arguments</legend>

              <pre class="fragment"><code class="shell">
$ docker image build --build-arg IMAGE_TAG="image-tag" --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>ARG is the only instruction allowed before FROM</p>
              <p>Not mandatory to put a value to an ARG in the Docker file => mandatory build parameter.</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim data-line-numbers="1,5|1-8">
FROM some-image:tag

ARG BUILD_OPTION="-vvv"

RUN /usr/bin/some-command

RUN /usr/bin/some-other-command ${BUILD_OPTION} && \
    /usr/bin/whatever
              </code></pre>
              <legend>Install and configure the image through RUN</legend>
            </div>

            <aside class="notes">
              <p>basically, run contains anything you can run in a terminal</p>
              <p>Explain the concept of layers, present pros and cons of one layer vs multiple</p>
              <ul>
                <li>One layer ‚Üí allows cleaning and keep image size under control</li>
                <li>Multi layer ‚Üí allows for more efficient cache, very useful to test when creating the Dockerfile</li>
              </ul>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim data-line-numbers="1|1-3|1-5|1-7|1-9|1-11">
FROM some-image:tag

COPY ./docker/some-config.ini /etc/some-config/default.ini

EXPOSE 8080

VOLUME /data

WORKDIR /tmp

USER root
              </code></pre>
              <legend>Add, share and expose data</legend>
            </div>

            <aside class="notes">
              <p>COPY can also be used to copy from another Docker image</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim>
FROM some-image:tag

ENV MY_VAR = "Hello!"

CMD ["/bin/sh", "-c", "echo ${MY_VAR}"]
              </code></pre>
              <legend>Running a default command - exec form (preferred one)</legend>

              <pre class="fragment" data-fragment-index="1"><code class="dockerfile" data-trim>
FROM some-image:tag

ENV MY_VAR = "Hello!"

CMD echo "${MY_VAR}"
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Running a default command - shell form</legend>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container --rm run my-image:my-tag ps aux
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Running a default command - override the command</legend>
            </div>

            <aside class="notes">
              <p>exec form prevents shell execution, it is more secure.</p>
              <p>shell form is like wrapping the cmd in `/bin/sh -c "cmd content"`</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim>
FROM some-image:tag

ENTRYPOINT ["top", "-b"]
              </code></pre>
              <legend>Using the entrypoint - exec form (preferred)</legend>

              <pre class="fragment" data-fragment-index="1"><code class="dockerfile" data-trim>
FROM some-image:tag

ENTRYPOINT exec top -b
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Using the entrypoint - shell form</legend>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container --rm run --entrypoint="exec ps aux" my-image:my-tag
              </code></pre>
              <legend class="fragment" data-fragment-index="2">
                Running a default command - override the entrypoint
              </legend>
            </div>

            <aside class="notes">
              <p>Basically, entrypoint and cmd are concatenated</p>
              <p>exec in shell form to prevent docker stop to be blocked on long processes</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim>
FROM some-image:tag

ENTRYPOINT ["echo", "-e"]

CMD ["Hello!"]
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container --rm run my-image:my-tag Coucou
              </code></pre>

              <legend>Combining command and entrypoint</legend>
            </div>

            <aside class="notes">
              <p>https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time">Build an image that serves the Symfony skeleton</li>
                <li class="fragment practice-constraint">
                  User <code class="inline-code">debian:stable-slim</code> as base
                </li>
                <li class="fragment practice-constraint">Copy the Symfony code in the image</li>
                <li class="fragment practice-constraint">Use PHP internal server to serve the app</li>
                <li class="fragment practice-success">
                  <code class="inline-code">docker container run -P -d built-image</code> must be enough to serve the
                  app
                </li>
              </ul>
            </div>

            <aside class="notes">
              <p>Try to minimize the size of the image</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="‚Äù_blank‚Äù" href="./practice/build-an-image/Dockerfile.base.html">Solution</a></h3>
            </div>

            <aside class="notes">
              <p>Discuss what is wrong with this solution ‚Üí useless elements (like Composer) in the resulting image</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Multistage building</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="dockerfile" data-trim data-line-numbers="1|1-3|5-11|13-19">
FROM some-image:tag as base

RUN apt install something-needed-for-production

FROM base as builder

RUN apt install something-needed-for-building-your-app

COPY . .

RUN dependency-installation

FROM base as prod

COPY --from=builder /path/in/builder /path/for/prod

WORKDIR /path/for/prod

CMD ["your-app", "--an-option"]
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker image build --target=prod --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>With a compiled language, your prod image will be from "scratch", because you only need the binary</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time">Upgrade the previous Dockerfile with multistage building</li>
                <li class="fragment practice-constraint">
                  Separate between <code class="inline-code">base</code>, <code class="inline-code">builder</code>, and
                  <code class="inline-code">prod</code> stages
                </li>
                <li class="fragment practice-success">
                  <code class="inline-code">docker container run -P -d built-image</code> must still be enough to serve
                  the app
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="‚Äù_blank‚Äù" href="./practice/build-an-image/Dockerfile.multistage.html">Solution</a></h3>
            </div>

            <aside class="notes"></aside>
          </section>
        </section>

        <section id="docker-compose">
          <section>
            <h2>Docker compose</h2>

            <img alt="compose.png" src="images/compose.png" />

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - What is it?</h2>

            <div class="centered-slide-content">
              <div class="fragment">A tool for defining and running multi-container Docker applications</div>

              <br />

              <div class="fragment">
                Based on the Compose file (YAML format) and the corresponding compose specification
              </div>

              <br />

              <div class="fragment">Two major versions:</div>
              <ul>
                <li class="fragment">v1: <code class="inline-code">docker-compose</code> ‚ö†Ô∏è abandoned ‚ö†Ô∏è</li>
                <li class="fragment">v2: <code class="inline-code">docker compose</code></li>
              </ul>
            </div>

            <aside class="notes">
              <p>
                Docker Compose v1 was a Python script, independent. Deprecated for more than 2 years and officially
                abandoned since July 2023
              </p>
              <p>Docker Compose v2 is a Docker plugin</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - The Compose file</h2>

            <div class="centered-slide-content">
              <pre><code class="yaml" data-trim data-line-numbers="1|2-3|4|7-9|12-14|16-18,23-24|15|10-11,20-21|5-6">
# compose.yaml|compose.yml|docker-compose.y[a]ml
services:
  my-app:
    image: my-app-image:latest
    command: ["executable", "arg"]
    entrypoint: ["executable", "arg"]
    environment:
      MY_VAR: "my value"
      ANOTHER_VAR: "${A_HOST_VAR:-default value}"
    networks:
      - my-app
    ports:
      - 3000:3000
      - 5000:5000
    user: root
    volumes:
      - ./:/app
      - data-volume:/data

networks:
  my-app:

volumes:
  data-volume:
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Run the Symfony app</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-time" data-fragment-index="1">
                  Write a compose file allowing to run a Symfony app
                </li>
                <li class="fragment practice-constraint" data-fragment-index="2">
                  Use the custom image we built previously
                </li>
                <li class="fragment practice-constraint" data-fragment-index="3">
                  Share composer config and cache between host and container
                </li>
                <li class="fragment practice-success" data-fragment-index="4">
                  You can access the app through localhost:8080
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="5">Commands to use</div>
              <ul class="fragment" data-fragment-index="5">
                <li><code class="inline-code">docker compose up -d</code> to start the app</li>
                <li>
                  <code class="inline-code">docker compose exec &lt;service name&gt;</code> to go in the container
                </li>
                <li><code class="inline-code">docker compose logs &lt;service name&gt;</code> to check the logs</li>
              </ul>
            </div>

            <aside class="notes">
              <p>exec will lend you in the first container.</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Run the Symfony app</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre><code class="yaml" data-trim>
services:
  app:
    image: local/symfony:latest
    # command: ["php", "-S", "0.0.0.0:8000", "-t", "public"]
    environment:
      COMPOSER_CACHE_DIR: /tmp/composer/cache
      COMPOSER_HOME: /tmp/composer/config
    ports:
      - 8080:8000
    user: 1000:1000
    volumes:
      - ~/.config/cache:/tmp/composer/cache
      - ~/.config/composer:/tmp/composer/config
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Additional tricks</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="yaml" data-trim>
services:
  app:
    image: local/symfony:latest
    deploy:
      replicas: 10
    ports:
      - 8080-8089:8000
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Create 10 replicas of the same service</legend>

              <br />

              <div class="fragment" data-fragment-index="2">Rename the service and try to stop the services:</div>
              <pre class="fragment" data-fragment-index="2"><code class="shell" data-trim>
$ docker compose down
              </code></pre>
              <pre class="fragment" data-fragment-index="3"><code class="shell" data-trim>
$ docker compose down --remove-orphans
              </code></pre>
            </div>

            <aside class="notes">
              <p>
                "docker compose up -d" will detect any change and only up the services that changed. Try to run it
                several times.
              </p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Additional tricks</h2>

            <div class="centered-slide-content">
              <pre><code class="shell" data-trim>
$ docker compose run --rm app bash
              </code></pre>
              <legend>Override the command</legend>
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell" data-trim>
$ docker compose run -d --rm app
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Detached mode</legend>
              <br />

              <pre class="fragment" data-fragment-index="3"><code class="shell" data-trim>
$ docker compose run -d --rm --service-ports app
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Binding port does not work by default</legend>
              <br />
            </div>

            <aside class="notes">
              <p>compose run alone will not bind the ports</p>
              <p>No need for "-i -t" with compose, it is the default. You have -T deactivating it.</p>
            </aside>
          </section>
        </section>

        <section id="phpstorm">
          <section>
            <h2>Running and Debugging with PHPStorm</h2>

            <img alt="cat.png" src="images/cat.png" />

            <aside class="notes">
              <!-- -->
            </aside>
          </section>

          <section>
            <h2>Advanced usage: testing and debugging</h2>

            <ul>
              <li class="fragment">Behat</li>
              <li class="fragment">Xdebug CLI</li>
              <li class="fragment">Xdebug UI</li>
              <li class="fragment">php-meminfo</li>
            </ul>

            <aside class="notes">
              <!-- -->
            </aside>
          </section>

          <section>
            <h2>Building your own Dockerfile</h2>

            <pre><code class="dockerfile">FROM akeneo/fpm:php-7.1

RUN apt-get update && \
    apt-get --yes --quiet install php7.1-dev && \
    apt-get clean && apt-get --yes --quiet autoremove --purge && \
    rm -rf  /var/lib/apt/lists/* /tmp/* /var/tmp/* \
            /usr/share/doc/* /usr/share/groff/* /usr/share/info/* /usr/share/linda/* \
            /usr/share/lintian/* /usr/share/locale/* /usr/share/man/*

RUN cd /tmp && \
    git clone https://github.com/BitOne/php-meminfo.git && \
    cd php-meminfo/extension/php7 && \
    phpize && \
    ./configure --enable-meminfo && \
    make && \
    make install

COPY meminfo.ini /etc/php/7.1/mods-available/meminfo.ini

RUN phpenmod meminfo
        </code></pre>

            <aside class="notes">
              <!-- -->
            </aside>
          </section>

          <section>
            <h2>Building your own Dockerfile</h2>

            <pre><code>extension=meminfo.so</code></pre>

            <pre class="fragment"><code class="yaml">services:
  fpm:
    image: akeneo/fpm:php-7.1
        </code></pre>

            <pre class="fragment"><code class="yaml">services:
  fpm:
    build: ./docker/fpm/
        </code></pre>

            <pre class="fragment"><code class="shell">$ docker-compose up -d --build</code></pre>

            <aside class="notes">
              <!-- -->
            </aside>
          </section>
        </section>

        <section id="glossary">
          <section>
            <h2>Using Docker - Command glossary</h2>

            <table class="centered-slide-content" style="width: 100%">
              <tr>
                <th style="width: 50%; text-align: center">Command</th>
                <th style="width: 50%; text-align: center">Usage</th>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker image pull</td>
                <td style="width: 50%; text-align: justify">Pull an image from a repository</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker image ls [-a]</td>
                <td style="width: 50%; text-align: justify">List all images on your machine</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker container ls [-a]</td>
                <td style="width: 50%; text-align: justify">List all containers on you machine</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker container run -i -t --rm image command</td>
                <td style="width: 50%; text-align: justify">Run a container in interactive mode</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker container run -d image</td>
                <td style="width: 50%; text-align: justify">Run a container in detached mode</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker container exec container_name command</td>
                <td style="width: 50%; text-align: justify">Execute a command inside a running container</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker container rm [-f -v] container_name|id</td>
                <td style="width: 50%; text-align: justify">Delete a container</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker image rm [-f] image_name|id</td>
                <td style="width: 50%; text-align: justify">Delete an image</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: left">docker system prune --volume</td>
                <td style="width: 50%; text-align: justify">Clean everything</td>
              </tr>
            </table>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Command glossary</h2>

            <table style="width: 100%">
              <tr>
                <th style="width: 50%; text-align: center">New commands</th>
                <th style="width: 50%; text-align: center">Old commands</th>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker image pull</td>
                <td style="width: 50%; text-align: center">docker pull</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker image ls [-a]</td>
                <td style="width: 50%; text-align: center">docker images [-a]</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker container ls [-a]</td>
                <td style="width: 50%; text-align: center">docker ps [-a]</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker container run</td>
                <td style="width: 50%; text-align: center">docker run</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker container exec</td>
                <td style="width: 50%; text-align: center">docker exec</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker container rm</td>
                <td style="width: 50%; text-align: center">docker rm</td>
              </tr>
              <tr>
                <td style="width: 50%; text-align: center">docker image rm</td>
                <td style="width: 50%; text-align: center">docker rmi</td>
              </tr>
            </table>
            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Command glossary</h2>

            <table style="width: 100%">
              <tr>
                <th style="width: 30%; text-align: center">Command</th>
                <th style="width: 70%; text-align: center">Usage</th>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose pull</td>
                <td style="width: 60%; text-align: justify">Pull all the images of your compose file</td>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose up -d</td>
                <td style="width: 60%; text-align: justify">Create the containers of your compose file</td>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose ps</td>
                <td style="width: 60%; text-align: justify">
                  List all containers of your compose file (running or not)
                </td>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose stop</td>
                <td style="width: 60%; text-align: justify">Stop all containers of your compose file</td>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose start</td>
                <td style="width: 60%; text-align: justify">Restart all stopped containers of your compose file</td>
              </tr>
              <tr>
                <td style="width: 40%; text-align: left">docker-compose down [-v]</td>
                <td style="width: 60%; text-align: justify">
                  Destroy all containers (and volumes) of your compose file
                </td>
              </tr>
            </table>

            <aside class="notes"></aside>
          </section>
        </section>
      </div>
    </div>
    <script type="module" src="/main.js"></script>
  </body>
</html>
