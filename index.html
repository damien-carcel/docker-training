<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="utf-8" />

    <title>How to develop in PHP with Docker and Docker Compose</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <meta name="description" content="Development in PHP with Docker" />
    <meta name="author" content="Damien Carcel" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
    />
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <section id="presentation-title">
          <h2>Developing in PHP<br />with Docker and Docker Compose</h2>

          <br />
          <br />

          <h3>Damien Carcel</h3>
        </section>

        <section id="plan">
          <section>
            <h2>What will we see?</h2>

            <div class="centered-slide-content">
              <ul class="plan">
                <li class="fragment">Presentation of Docker</li>
                <li class="fragment">How to use only Docker to create and run a Symfony app</li>
                <li class="fragment">How to use Docker Compose to ease our workflow</li>
              </ul>
            </div>

            <aside class="notes">
              <p>
                We will not use the Symfony CLI tool and its built-in server, only pure PHP, as I want to keep things
                simple.
              </p>
              <p>If enough time, we will se how to run and debug our app in an IDE</p>
            </aside>
          </section>

          <section>
            <h2>Practice</h2>

            <div class="centered-slide-content">
              <ul class="plan">
                <li class="practice-goal">Goal</li>
                <li class="practice-constraint">Constraints</li>
                <li class="practice-success">Success criteria</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>
        </section>

        <section id="presentation">
          <section>
            <h2>What is (not) Docker?</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">Docker is not a virtual machine (VM)</li>
              </ul>

              <br />

              <img alt="virtualization.svg" src="images/virtualization.svg" class="fragment" />
            </div>

            <aside class="notes">A VM runs a full operating system on virtualized hardware.</aside>
          </section>

          <section>
            <h2>Docker is a container orchestrator</h2>

            <div class="centered-slide-content">
              <img alt="vms_vs_containers.jpg" src="images/vms_vs_containers.jpg" />
              <p>Virtual machines vs. containers</p>
            </div>

            <aside class="notes">
              <p>Containers remove the hardware virtualization and the guest OS.</p>
              <p>The Docker engine has access to the real hardware and uses the host Linux kernel.</p>
              <p>Except on macOS and Windows, as Docker runs in a VM providing a GNU/Linux OS.</p>
            </aside>
          </section>

          <section>
            <h2>A few definitions</h2>

            <div class="centered-slide-content">
              <div class="fragment">
                A container is a standard unit of software that packages up code and all its dependencies so the
                application runs quickly and reliably from one computing environment to another
              </div>

              <br />
              <br />

              <div class="fragment">
                A Docker container image is a lightweight, standalone, executable package of software that includes
                everything needed to run an application: code, runtime, system tools, system libraries and settings.
              </div>
            </div>

            <aside class="notes">
              <p>
                Images built from the Dockerfile follow the
                <a href="https://opencontainers.org/">Open Container Initiative</a> specifications.
              </p>
              <p>They are other container systems, like LXC/LXD, not based on the OCI</p>
            </aside>
          </section>

          <section>
            <h2>Docker specificity</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">Only one process in the container</li>
                <li class="fragment" data-fragment-index="2">Dockerfile ‚Üí Image ‚Üí Containers</li>
              </ul>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="3"><code class="dockerfile">
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get --no-install-recommends --no-install-suggests install php && \
    apt-get clean && \
    apt-get autoremove --purge
              </code></pre>
              <legend class="fragment" data-fragment-index="3">A Dockerfile example</legend>
            </div>

            <aside class="notes">
              <p>
                Images built from the Dockerfile follow the
                <a href="https://opencontainers.org/">Open Container Initiative</a> specifications.
              </p>
              <p>They are other container systems, like LXD/LXD, not based on the OCI</p>
            </aside>
          </section>
        </section>

        <section id="using-docker">
          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <img src="images/docker.png" />
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <h3>The very basics</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Invoking the Docker CLI</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker
              </code></pre>
            </div>

            <aside class="notes">
              <p>Present briefly the various Docker available commands</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Pulling an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">Pull the latest Debian &ldquo;slim&rdquo; image</li>
                <li class="fragment" data-fragment-index="4">List the pulled images</li>
              </ul>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker image pull debian:bookworm-slim
              </code></pre>
              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker image pull debian:12-slim
              </code></pre>

              <pre class="fragment" data-fragment-index="4"><code class="shell">
$ docker image ls
            </code></pre>
            </div>

            <aside class="notes">
              <p>Explain "pull" and the tag system</p>
              <p>Same ID for same layer => explain the layers</p>
              <p>"docker image ls" same thing that "docker images"</p>
              <p>Docker image also proposes history and inspect, just show it very briefly</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Running a container</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ docker container run [options] debian:12-slim [command]
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Basic run example</legend>
            </div>

            <aside class="notes">
              <p>Before image name: options; after image name: command that will run in the container</p>
              <p>Try "ls -al" as an example</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Running a container</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">Use bash in a container</li>
                <br />
                <li class="fragment practice-success" data-fragment-index="2">
                  You need to be able to fully interact<br />
                  with the console inside your container
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="3">Tips</div>
              <ul class="fragment" data-fragment-index="3">
                <li>You need to allocate a pseudo TTY</li>
                <li>You need to keep STIN open</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Running a container</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ docker container run -i -t debian:12-slim bash
$ docker container ls -a
$ docker container rm &lt;container name&gt;
              </code></pre>

              <div class="fragment" data-fragment-index="2">or</div>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container run -i -t --rm debian:12-slim bash
              </code></pre>
            </div>

            <aside class="notes">
              <p>docker container ls -a shows stopped containers</p>
              <p>`--rm` is a must-use</p>
            </aside>
          </section>

          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <h3>Let's go further</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">
                  <code class="shell inline-code">docker container run --env VAR=value</code> can create variables
                  inside the container
                </li>
                <br />
                <li class="fragment">It will override the value if the variable already exists</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">
                  Display a host environment variable in a container
                </li>
                <br />
                <li class="fragment practice-constraint" data-fragment-index="2">
                  Export an environment variable in your terminal
                </li>
                <li class="fragment practice-constraint" data-fragment-index="3">
                  The only time you write the value must be for the "export"
                </li>
                <br />
                <li class="fragment practice-success" data-fragment-index="5">
                  The value is displayed in your terminal
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="6">Tips</div>
              <pre class="fragment" data-fragment-index="6"><code class="shell" data-trim>
$ export MY_VAR="Hello"
$ echo ${VARIABLE_NAME}
              </code></pre>
              <legend class="fragment" data-fragment-index="6">Display an environment variable</legend>
            </div>

            <aside class="notes">
              <p>Don't make them try a one-line here, too much side effects</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Environment variables</h2>

            <div class="centered-slide-content">
              <h3>Solutions</h3>

              <pre><code class="shell">
$ export HOST_VAR=Hello
$ docker container run -e CONTAINER_VAR=$HOST_VAR debian:12-slim \
    sh -c 'echo $CONTAINER_VAR'
              </code></pre>

              <div class="fragment" data-fragment-index="1">or</div>

              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ export MY_VAR=Hello
$ docker container run -e MY_VAR debian:12-slim sh -c 'echo $MY_VAR'
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Volumes</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment definition" data-fragment-index="1">
                  Volumes allow to persist data outside the container
                </li>
              </ul>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker volume create my-data
$ docker container run -v my-data:/path-in-container debian:12-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Create link a Docker volume to your container</legend>
            </div>

            <aside class="notes">
              <p>Show an example by running a MySQL container and inspect the volume to find its path</p>
              <p>Most of the major management commands propose `inspect`, use it to show the content of MySQL</p>
              <p>Always host path first, then container path</p>
              <p>Having the volume allows to bind it to another, new container if the original one was destroyed</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Bind mount</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment definition" data-fragment-index="1">
                  Mount a file or directory from the host into the container.
                </li>
              </ul>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container run \
    -v /path-on-host:/path-in-container \
    debian:12-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="2">
                Bind mount a folder/file from your host inside the container - old way
              </legend>

              <br />

              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker container run \
    --mount type=bind,source=/path-on-host,target=/path-in-container \
    debian:12-slim
              </code></pre>
              <legend class="fragment" data-fragment-index="3">
                Bind mount a folder/file from your host inside the container - new way
              </legend>
            </div>

            <aside class="notes">
              <p>The new mount option works with volumes too, with type=volume</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Bind mount</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Bind-mount a directory from your host into the container</li>
                <br />
                <li class="fragment practice-constraint">
                  Bind-mount <code class="inline-code">/home/&lt;your login&gt;/training</code> into
                  <code class="inline-code">/data</code>
                </li>
                <li class="fragment practice-constraint">
                  Create a file with <code class="inline-code">echo "This is a test" > /data/test.txt</code>
                </li>
                <br />
                <li class="fragment practice-success">You can open the file and it contains the expected content</li>
              </ul>
            </div>

            <aside class="notes">
              <p>We ran the container as "root", so the file was created owned by "root" as well.</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Bind mount</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre><code class="shell" data-trim data-line-numbers="1-2|1-8|1-12|1-14">
## Create your directory first on the host or it will be owned by root ##
$ mkdir /home/&lt;your login&gt;/training

$ docker container run -i -t --rm \
    --mount type=bind,source=/home/&lt;your login&gt;/training,target=/data \
    debian:12-slim bash

 ## Now you are in the container ##

$ echo "This is a test" > /data/test.txt

 ## CTRL+D to exit ##

$ cat /home/&lt;your login&gt;/training/test.txt
              </code></pre>

              <ul class="fragment">
                <li class="practice-question">Can you spot what's wrong in the result?</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">
                  <code class="shell inline-code">docker container run --user &lt;username or IDs&gt;</code> allows to
                  specify a user inside the container
                </li>
                <br />
                <li class="fragment">username must correspond to an existing user</li>
                <br />
                <li class="fragment">User IDs can correspond to nothing</li>
                <br />
                <li class="fragment">It will override any user already specified as default in the Dockerfile</li>
              </ul>
            </div>

            <aside class="notes">
              <p>IMPORTANT: `-u user` ‚Üí "user" is the user in the container, not on your host</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Fix the previous exercise issue</li>
                <br />
                <li class="fragment practice-constraint">
                  Again, run a container while bind-mounting,<br />
                  but this time specify a user
                </li>
                <li class="fragment practice-constraint">Create a file in <code class="inline-code">/data</code></li>
                <br />
                <li class="fragment practice-success">
                  You can edit from your host<br />
                  the file you created in the container
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - User</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="shell">
$ sudo chown -R $(id -u):$(id -g) /home/&lt;your login&gt;/training

$ docker container run -i -t --rm \
    -u $(id -u):$(id -g) \
    --mount type=bind,source=/home/&lt;your login&gt;/training,target=/data \
    debian:12-slim bash
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - workdir</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment definition">Specifies the working directory of a container</li>
              </ul>

              <br />
              <br />

              <pre class="fragment"><code class="shell">
$ docker container run -i -t --rm --workdir /data debian:12-slim bash
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <h3>Create and serve a Symfony app with Docker only</h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Create a Symfony app</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">
                  Use the <code class="inline-code">composer:latest</code> Docker image to create a Symfony app
                </li>
                <br />
                <li class="fragment practice-constraint" data-fragment-index="2">
                  <code class="inline-code">/home/&lt;your login&gt;/training/composer/config</code> on your host
                </li>
                <li class="fragment practice-constraint" data-fragment-index="2">
                  <code class="inline-code">/tmp/composer/config</code> inside the container
                </li>
                <li class="fragment practice-constraint" data-fragment-index="3">
                  <code class="inline-code">/home/&lt;your login&gt;/training/composer/cache</code> on your host
                </li>
                <li class="fragment practice-constraint" data-fragment-index="3">
                  <code class="inline-code">/tmp/composer/cache</code> inside the container
                </li>
                <li class="fragment practice-constraint" data-fragment-index="4">
                  Must be done in one line in your terminal
                </li>
                <br />
                <li class="fragment practice-success" data-fragment-index="5">
                  You have an editable Symfony Skeleton in<br />
                  <code class="inline-code">/home/&lt;your login&gt;/training/my-app</code> on your host
                </li>
              </ul>
            </div>

            <aside class="notes">
              <p>composer create-project symfony/skeleton app</p>
              <p>COMPOSER_HOME="/path/to/config"</p>
              <p>COMPOSER_CACHE_DIR="/path/to/cache"</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Create a Symfony app</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="shell">
$ mkdir -p training/composer/config training/composer/cache

$ docker container run -i -t --rm \
    -u $(id -u):$(id -g) \
    -e COMPOSER_HOME="/tmp/composer/config" \
    -e COMPOSER_CACHE_DIR="/tmp/composer/cache" \
    --mount type=bind,source=/home/&lt;your login&gt;/training/composer,target=/tmp/composer \
    -w /data \
    --mount type=bind,source=/home/&lt;your login&gt;/training,target=/data \
    composer:latest composer create-project symfony/skeleton my-app
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Publishing ports</h2>

            <div class="centered-slide-content">
              <ul class="fragment" data-fragment-index="1">
                <li class="definition">Maps a host port number with a container port number</li>
              </ul>

              <br />
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container run --rm -u 1000:1000 \
    -p 8080:8000 \
    -w /data -v /home/damien/training/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Expose the app on port 8080</legend>
            </div>

            <aside class="notes">
              <p>Like for the volumes, the first port is on the host, the second in the container</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Detached mode</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment definition">Runs a container as a background process</li>
              </ul>

              <br />
              <br />

              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 \
    -d \
    -p 8080:8000 \
    -w /data -v /home/damien/training/my-app:/data \
    composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>
            </div>

            <aside class="notes">
              <p>"Detached" mode gives you the terminal back right away</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Display logs</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="shell">
$ docker container logs my-app-container
              </code></pre>

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker container logs -f --tail 1 my-app-container
              </code></pre>

              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker container run --name &lt;container name&gt;
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Easier if we choose the container name ourselves</legend>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Manipulate a detached container</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker container exec -i -t my-app-container bash
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container stop my-app-container
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Container isolation</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="shell">
$ docker container run --rm -u 1000:1000 -d --name my-app-container \
    -w /data -v /home/damien/training/my-app:/data \
    -p 8080:8000 composer:latest php -S 0.0.0.0:8000 -t public
              </code></pre>

              <ul>
                <li class="fragment practice-question">Could you access this app from another container?</li>
              </ul>

              <br />
              <br />

              <div class="fragment">Yes, you can üëç</div>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Container isolation</h2>

            <div class="centered-slide-content">
              <pre><code class="shell">
$ docker container inspect
### Retrieve the IP address ###
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker container run -i -t --rm curlimages/curl curl &lt;IP address&gt;:8000
### Will display Symfony dev page ###
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Networks</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment definition">A network allows containers to communicate with each other</li>
                <li class="fragment practice-constraint">
                  Two containers each on a different network cannot communicate
                </li>
              </ul>

              <br />
              <br />

              <pre class="fragment"><code class="shell">
$ docker network create my-network
$ docker container run -i -t --rm --network my-network \
    curlimages/curl curl 172.17.0.2:8000
### You cannot access the other container anymore ###
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>How to use Docker</h2>

            <div class="centered-slide-content">
              <h3>What if we built our own custom image</h3>
              <div class="fragment">Now you can use your IDE üíª</div>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="dockerfile">
FROM some-image:image-tag
              </code></pre>
              <legend class="fragment" data-fragment-index="1">The most basic Dockerfile you can write</legend>

              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker image build --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>Present "builder" management command and "buildx" plugin.</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content" data-line-numbers="3">
              <pre><code class="dockerfile" data-line-numbers="3|3-5|3-6">

FROM some-image:image-tag

ARG MY_ARG = "An environment variable only available at build time"
ENV MY_VAR = "An environment variable that will stay at runtime"
              </code></pre>
              <legend>Environment variables and arguments</legend>

              <pre class="fragment"><code class="shell">
$ docker image build --build-arg MY_ARG="An overriding value" --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content" data-line-numbers="3">
              <pre><code class="dockerfile" data-trim data-line-numbers="1-3">
ARG IMAGE_TAG

FROM some-image:${IMAGE_TAG}

ARG MY_ARG="An environment variable only available at build time"
ENV MY_VAR="An environment variable that will stay at runtime"
              </code></pre>
              <legend>Environment variables and arguments</legend>

              <pre class="fragment"><code class="shell">
$ docker image build --build-arg IMAGE_TAG="image-tag" --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>ARG is the only instruction allowed before FROM</p>
              <p>Not mandatory to put a value to an ARG in the Docker file => mandatory build parameter.</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim data-line-numbers="1,5|1-8">
FROM some-image:tag

ARG BUILD_OPTION="-vvv"

RUN /usr/bin/some-command

RUN /usr/bin/some-other-command ${BUILD_OPTION} && \
    /usr/bin/whatever
              </code></pre>
              <legend>Install and configure the image through RUN</legend>
            </div>

            <aside class="notes">
              <p>basically, run contains anything you can run in a terminal</p>
              <p>Explain the concept of layers, present pros and cons of one layer vs multiple</p>
              <ul>
                <li>One layer ‚Üí allows cleaning and keep image size under control</li>
                <li>Multi layer ‚Üí allows for more efficient cache, very useful to test when creating the Dockerfile</li>
              </ul>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim data-line-numbers="1|1-3|1-5|1-7|1-9|1-11">
FROM some-image:tag

COPY ./docker/some-config.ini /etc/some-config/default.ini

EXPOSE 8080

VOLUME /data

WORKDIR /tmp

USER root
              </code></pre>
              <legend>Add, share and expose data</legend>
            </div>

            <aside class="notes">
              <p>COPY can also be used to copy from another Docker image</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <pre><code class="dockerfile" data-trim>
FROM some-image:tag

ENV MY_VAR = "Hello!"

CMD ["/bin/sh", "-c", "echo ${MY_VAR}"]
              </code></pre>
              <legend>Running a default command - exec form (preferred one)</legend>

              <br />

              <pre class="fragment" data-fragment-index="1"><code class="dockerfile" data-trim>
FROM some-image:tag

ENV MY_VAR = "Hello!"

CMD echo "${MY_VAR}"
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Running a default command - shell form</legend>
            </div>

            <aside class="notes">
              <p>exec form prevents shell execution, it is more secure.</p>
              <p>shell form is like wrapping the cmd in `/bin/sh -c "cmd content"`</p>
              <p>There is also the entrypoint/p></p>
              <p>https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Build an image that serves the Symfony skeleton</li>
                <br />
                <li class="fragment practice-constraint">Use the provided Dockerfile (it misses 1 instruction!)</li>
                <li class="fragment practice-constraint">Use PHP internal server to serve the app</li>
                <li class="fragment practice-constraint">
                  <code class="inline-code">docker container run -P -d local/symfony-skeleton</code>
                  must be enough to serve the app
                </li>
                <br />
                <li class="fragment practice-success">You can access the Symfony app in your browser</li>
              </ul>
            </div>

            <aside class="notes">
              <p>Provide the image and the "ini" file</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="_blank" href="./practice/build-an-image/dockerfile.base.html">Solution</a></h3>
            </div>

            <aside class="notes">
              <p>Discuss what is wrong with this solution ‚Üí useless elements (like Composer) in the resulting image</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Multistage building</h2>

            <div class="centered-slide-content">
              <pre class="fragment"><code class="dockerfile" data-trim data-line-numbers="1|1-3|5-11|13-19">
FROM some-image:tag as base

RUN apt install something-needed-for-production

FROM base as builder

RUN apt install something-needed-for-building-your-app

COPY . .

RUN dependency-installation

FROM base as prod

COPY --from=builder /path/in/builder /path/for/prod

WORKDIR /path/for/prod

CMD ["your-app", "--an-option"]
              </code></pre>

              <pre class="fragment"><code class="shell">
$ docker image build --target=prod --tag my-image:my-tag .
              </code></pre>
            </div>

            <aside class="notes">
              <p>With a compiled language, your prod image will be from "scratch", because you only need the binary</p>
            </aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Upgrade the previous Dockerfile with multistage building</li>
                <br />
                <li class="fragment practice-constraint">
                  Separate between <code class="inline-code">base</code>, <code class="inline-code">builder</code>, and
                  <code class="inline-code">prod</code> stages
                </li>
                <br />
                <li class="fragment practice-success">
                  <code class="inline-code">docker container run -P -d local/symfony-skeleton</code>
                  must still be enough to serve the app
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="_blank" href="./practice/build-an-image/dockerfile.multistage.html">Solution</a></h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Command glossary</h2>

            <div class="centered-slide-content">
              <table style="width: 100%; font-size: smaller">
                <tr>
                  <th style="width: 50%; text-align: center">Command</th>
                  <th style="width: 50%; text-align: center">Usage</th>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: left">docker image pull &lt;image name&gt;</td>
                  <td style="width: 50%; text-align: justify">Pull an image from a repository</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: left">docker image ls [-a]</td>
                  <td style="width: 50%; text-align: justify">List all images on your machine</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: left">docker image rm &lt;image name&gt;</td>
                  <td style="width: 50%; text-align: justify">Delete an image</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: left">docker system prune --volumes</td>
                  <td style="width: 50%; text-align: justify">Clean everything unneeded</td>
                </tr>
              </table>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Command glossary</h2>

            <div class="centered-slide-content">
              <table style="width: 100%; font-size: smaller">
                <tr>
                  <th style="width: 65%; text-align: center">Command</th>
                  <th style="width: 35%; text-align: center">Usage</th>
                </tr>
                <tr>
                  <td style="width: 65%; text-align: left">docker container run -it --rm &lt;image name&gt; command</td>
                  <td style="width: 35%; text-align: justify">Run a container in interactive mode</td>
                </tr>
                <tr>
                  <td style="width: 65%; text-align: left">docker container run -d &lt;image name&gt; command</td>
                  <td style="width: 35%; text-align: justify">Run a container in detached mode</td>
                </tr>
                <tr>
                  <td style="width: 65%; text-align: left">docker container exec &lt;container name&gt; command</td>
                  <td style="width: 35%; text-align: justify">Execute a command inside a running container</td>
                </tr>
                <tr>
                  <td style="width: 65%; text-align: left">docker container ls [-a]</td>
                  <td style="width: 35%; text-align: justify">List all containers on you machine</td>
                </tr>
                <tr>
                  <td style="width: 65%; text-align: left">docker container rm [-f -v] &lt;container name&gt;</td>
                  <td style="width: 35%; text-align: justify">Delete a container</td>
                </tr>
              </table>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Using Docker - Command glossary</h2>

            <div class="centered-slide-content">
              <table style="width: 100%; font-size: smaller">
                <tr>
                  <th style="width: 50%; text-align: center">Management Commands</th>
                  <th style="width: 50%; text-align: center">Common commands</th>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker container run</td>
                  <td style="width: 50%; text-align: center">docker run</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker container exec</td>
                  <td style="width: 50%; text-align: center">docker exec</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker container ls</td>
                  <td style="width: 50%; text-align: center">docker ps</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker buildx build</td>
                  <td style="width: 50%; text-align: center">docker build</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker image pull</td>
                  <td style="width: 50%; text-align: center">docker pull</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker image ls</td>
                  <td style="width: 50%; text-align: center">docker images</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker container rm</td>
                  <td style="width: 50%; text-align: center">docker rm</td>
                </tr>
                <tr>
                  <td style="width: 50%; text-align: center">docker image rm</td>
                  <td style="width: 50%; text-align: center">docker rmi</td>
                </tr>
              </table>
            </div>

            <aside class="notes"></aside>
          </section>
        </section>

        <section id="docker-compose">
          <section>
            <h2>How to use Docker Compose</h2>

            <img alt="compose.png" src="images/compose.png" />

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - What is it?</h2>

            <div class="centered-slide-content">
              <div class="fragment">A tool for defining and running multi-container Docker applications</div>

              <br />

              <div class="fragment">
                Based on the Compose file (YAML format) and the corresponding compose specification
              </div>

              <br />

              <div class="fragment">Two major versions:</div>
              <ul>
                <li class="fragment">v1: <code class="inline-code">docker-compose</code> ‚ö†Ô∏è abandoned ‚ö†Ô∏è</li>
                <li class="fragment">v2: <code class="inline-code">docker compose</code></li>
              </ul>
            </div>

            <aside class="notes">
              <p>
                Docker Compose v1 was a Python script, independent. Deprecated for more than 2 years and officially
                abandoned since July 2023
              </p>
              <p>Docker Compose v2 is a Docker plugin</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - The Compose file</h2>

            <div class="centered-slide-content">
              <pre><code class="yaml" data-trim data-line-numbers="1|2-3|4|6-8|11-13|15-19|15,20,25-26|14|9-10,22-23|5">
# compose.yaml|compose.yml|docker-compose.y[a]ml
services:
  app:
    image: app-image:latest
    command: ["executable", "arg"]
    environment:
      MY_VAR: "my value"
      ANOTHER_VAR: "${A_HOST_VAR:-default value}"
    networks:
      - app
    ports:
      - 3000:3000
      - 5000:5000
    user: root
    volumes:
      - ./:/app
      - type: bind
        source: ./
        target: /app
      - data-volume:/data

networks:
  app:

volumes:
  data-volume:
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Run the Symfony app</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">
                  Write a compose file allowing to run a Symfony app
                </li>
                <br />
                <li class="fragment practice-constraint" data-fragment-index="2">
                  Use the custom image <code class="inline-code">local/symfony-skeleton</code> we built previously
                </li>
                <br />
                <li class="fragment practice-success" data-fragment-index="4">
                  You can access the app through localhost:8080
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="5">Commands to use</div>
              <ul class="fragment" data-fragment-index="5">
                <li><code class="inline-code">docker compose up -d</code> to start the app</li>
                <li><code class="inline-code">docker compose logs &lt;service name&gt;</code> to check the logs</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Run the Symfony app</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre><code class="yaml" data-trim>
services:
  app:
    image: local/symfony:latest
    # command: ["php", "-S", "0.0.0.0:8000", "-t", "public"]
    ports:
      - 8080:8000
    user: 1000:1000
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Additional tricks</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="yaml" data-trim>
services:
  app:
    image: local/symfony:latest
    deploy:
      replicas: 10
    ports:
      - 8080-8089:8000
    user: 1000:1000
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Create 10 replicas of the same service</legend>

              <br />

              <div class="fragment" data-fragment-index="2">Rename the service and try to stop the services:</div>
              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker compose down
              </code></pre>
              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker compose down -v --remove-orphans
              </code></pre>
            </div>

            <aside class="notes">
              <p>
                "docker compose up -d" will detect any change and only up the services that changed. Try to run it
                several times.
              </p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Additional tricks</h2>

            <div class="centered-slide-content">
              <pre><code class="shell">
$ docker compose run --rm app bash
              </code></pre>
              <legend>Override the command</legend>
              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell">
$ docker compose run -d --rm app
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Detached mode</legend>
              <br />

              <pre class="fragment" data-fragment-index="3"><code class="shell">
$ docker compose run -d --rm --service-ports app
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Binding port does not work by default</legend>
              <br />
            </div>

            <aside class="notes">
              <p>compose run alone will not bind the ports</p>
              <p>No need for "-i -t" with compose, it is the default. You have -T deactivating it.</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="yaml" data-trim data-line-numbers>
services:
  app:
    build: .
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Basic build declaration</legend>

              <pre
                class="fragment"
                data-fragment-index="2"
              ><code class="yaml" data-trim data-line-numbers="1-3,6|1-3,6-7|1-7|1-8">
services:
  app:
    build:
      args:
        MY_ARG: value
      context: .
      dockerfile: Dockerfile
      target: prod
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Advanced build declaration</legend>
            </div>

            <aside class="notes">
              <p>Replace "image" with "build"</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <pre class="fragment" data-fragment-index="1"><code class="shell" data-trim>
$ docker compose build
              </code></pre>
              <legend class="fragment" data-fragment-index="1">Build an image with Docker Compose</legend>

              <br />

              <pre class="fragment" data-fragment-index="2"><code class="shell" data-trim>
$ docker compose build &lt;service name&gt;
              </code></pre>
              <legend class="fragment" data-fragment-index="2">Build an image for a specific service</legend>

              <br />

              <pre class="fragment" data-fragment-index="3"><code class="shell" data-trim>
$ docker compose up --build
$ docker compose up --build &lt;service name&gt;
              </code></pre>
              <legend class="fragment" data-fragment-index="3">Build and up at once</legend>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Build the Symfony app image with Docker Compose</li>
                <br />
                <li class="fragment practice-constraint">
                  <code class="inline-code">docker compose up -d --build app</code>
                </li>
                <br />
                <li class="fragment practice-success">You can still access the app through localhost:8080</li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="yaml" data-trim>
services:
  app:
    build:
      context: .
      target: prod
    ports:
      - 8080:8000
    user: 1000:1000
              </code></pre>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Let's raise the bar</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Introduce a new "dev" target for Composer usage</li>

                <br />

                <li class="fragment practice-constraint">
                  Share composer cache and config in <code class="inline-code">php-cli</code> service
                </li>
                <li class="fragment practice-constraint">
                  Have a dedicated service <code class="inline-code">built-in-server</code>
                  to serve the app which specify the command
                </li>
                <li class="fragment practice-constraint">This service bind-mounts the code</li>
                <li class="fragment practice-constraint">Do not touch "builder" and "prod" targets for now</li>

                <br />

                <li class="fragment practice-success">
                  The app run with <code class="inline-code">docker compose up -d built-in-server</code>
                </li>
                <li class="fragment practice-success">
                  You can run <code class="inline-code">docker compose run --rm php-cli composer update</code> without
                  errors
                </li>
              </ul>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="_blank" href="./practice/compose/compose-file.dev.html">Compose file solution</a></h3>

              <br />

              <h3><a target="_blank" href="./practice/compose/dockerfile.dev.html">Dockerfile solution</a></h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Let's raise the bar</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">
                  <code class="inline-code">docker compose run --rm php-cli composer req maker</code>
                </li>
                <li class="fragment">
                  <code class="inline-code">docker compose run --rm php-cli bin/console make:controller</code>
                </li>
              </ul>

              <br />
              <br />

              <div class="fragment">
                <a target="_blank" href="http://localhost:8000/test">http://localhost:8000/test</a>
              </div>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker compose - Let's raise the bar</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal">Run the app with NGINX and PHP FPM</li>

                <br />

                <li class="fragment practice-constraint">NGINX and FPM communicates through HTTP</li>
                <li class="fragment practice-constraint">NGINX and FPM are each in their own service</li>
                <li class="fragment practice-constraint">
                  The app run in prod env in the service named <code class="inline-code">php-fpm</code>
                </li>
                <li class="fragment practice-constraint">Nginx/FPM are isolated from the built-in server</li>

                <br />

                <li class="fragment practice-success">
                  The app run with <code class="inline-code">docker compose up -d nginx php-fpm</code>
                </li>
              </ul>
            </div>

            <aside class="notes">
              <p>FPM to be run with "php-fpm -F"</p>
            </aside>
          </section>

          <section>
            <h2>Docker compose - Building an image</h2>

            <div class="centered-slide-content">
              <h3><a target="_blank" href="./practice/compose/compose-file.complete.html">Compose file solution</a></h3>

              <br />

              <h3><a target="_blank" href="./practice/compose/dockerfile.complete.html">Dockerfile solution</a></h3>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker Compose - Command glossary</h2>

            <div class="centered-slide-content">
              <table style="width: 100%; font-size: smaller">
                <tr>
                  <th style="width: 55%; text-align: center">Command</th>
                  <th style="width: 45%; text-align: center">Usage</th>
                </tr>
                <tr>
                  <td style="width: 55%; text-align: left">docker compose pull</td>
                  <td style="width: 45%; text-align: justify">Pull all the images of your compose file</td>
                </tr>
                <tr>
                  <td style="width: 55%; text-align: left">docker compose build</td>
                  <td style="width: 45%; text-align: justify">
                    Build all or a selection of the images of your compose file
                  </td>
                </tr>
                <tr>
                  <td style="width: 55%; text-align: left">docker compose up -d</td>
                  <td style="width: 45%; text-align: justify">Create the containers of your compose file</td>
                </tr>
                <tr>
                  <td style="width: 55%; text-align: left">docker compose exec &lt;service name&gt;</td>
                  <td style="width: 45%; text-align: justify">Go inside a running container</td>
                </tr>
                <tr>
                  <td style="width: 55%; text-align: left">docker compose run [--rm] &lt;service name&gt;</td>
                  <td style="width: 45%; text-align: justify">Run a command using one of the services available</td>
                </tr>
              </table>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>Docker Compose - Command glossary</h2>

            <div class="centered-slide-content">
              <table style="width: 100%; font-size: smaller">
                <tr>
                  <th style="width: 40%; text-align: center">Command</th>
                  <th style="width: 60%; text-align: center">Usage</th>
                </tr>
                <tr>
                  <td style="width: 40%; text-align: left">docker compose ps [-a]</td>
                  <td style="width: 60%; text-align: justify">
                    List all running (or not) containers of your compose file
                  </td>
                </tr>
                <tr>
                  <td style="width: 40%; text-align: left">docker compose stop</td>
                  <td style="width: 60%; text-align: justify">Stop all containers of your compose file</td>
                </tr>
                <tr>
                  <td style="width: 40%; text-align: left">docker compose kill</td>
                  <td style="width: 60%; text-align: justify">Kill containers that don't want to stop</td>
                </tr>
                <tr>
                  <td style="width: 40%; text-align: left">docker compose start</td>
                  <td style="width: 60%; text-align: justify">Restart all stopped containers of your compose file</td>
                </tr>
                <tr>
                  <td style="width: 40%; text-align: left">docker compose down [-v]</td>
                  <td style="width: 60%; text-align: justify">
                    Destroy all containers (and volumes) of your compose file
                  </td>
                </tr>
              </table>
            </div>

            <aside class="notes"></aside>
          </section>
        </section>

        <section id="phpstorm">
          <section>
            <h2>Running and Debugging in an IDE</h2>

            <img alt="cat.png" src="images/cat.png" />

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>PHPStorm without any PHP local installation</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment">
                  Configure Docker in<br />
                  <code class="inline-code">Settings > Build, Execution, Deployment > Docker</code>
                </li>
                <li class="fragment">
                  Create a PHP "CLI interpreter" in <code class="inline-code">Settings > PHP</code>
                </li>
                <li class="fragment">
                  Configure Composer in <code class="inline-code">Settings > PHP > Composer</code>
                </li>

                <br />

                <li class="fragment">[Optional] Configure Test Frameworks, Quality Tools and Symfony</li>
              </ul>
            </div>

            <aside class="notes">
              <p>Same thing can be done with JavaScript</p>
              <p>Restart the project for Symfony conf to take full effect?</p>
              <p>Let's try to run bin/console</p>
              <p>Some stuff like configuration can be shared</p>
            </aside>
          </section>

          <section>
            <h2>VS Code without any PHP local installation</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment" data-fragment-index="1">
                  Configure DevContainers to use the <code class="inline-code">php-cli</code> service
                </li>
                <br />
                <li class="fragment" data-fragment-index="2">That's it!</li>
              </ul>
              <pre class="fragment" data-fragment-index="3"><code class="dockerfile">
RUN useradd php-user --shell /bin/bash --create-home \
  && usermod --append --groups sudo php-user \
  && echo 'ALL ALL = (ALL) NOPASSWD: ALL' >> /etc/sudoers \
  && echo 'php-user:secret' | chpasswd
              </code></pre>
              <legend class="fragment" data-fragment-index="3">
                Add a <code class="inline-code">php-user</code> user in the <code class="inline-code">dev</code> stage
              </legend>
            </div>

            <aside class="notes">
              <p>Also add git in the dev target for the Git extension to work</p>
            </aside>
          </section>

          <section>
            <h2>VS Code without any PHP local installation</h2>

            <div class="centered-slide-content">
              <pre><code class="yaml" data-trim data-line-numbers="1-2,6,13">
services:
  php-cli:
    build:
      context: .
      target: dev
    command: ["sleep", "infinity"]
    environment:
      COMPOSER_CACHE_DIR: /tmp/composer/cache
      COMPOSER_HOME: /tmp/composer/config
    networks:
      - dev
      - prod
    user: php-user
    volumes:
      - .:/app
      - ~/.cache/composer:/tmp/composer/cache
      - ~/.config/composer:/tmp/composer/config
    working_dir: /app
              </code></pre>
              <legend>Adapt the compose file</legend>
            </div>

            <aside class="notes"></aside>
          </section>

          <section>
            <h2>VS Code without any PHP local installation</h2>

            <div class="centered-slide-content">
              <pre><code class="json" data-trim data-line-numbers="2-6|7-19">
{
  "dockerComposeFile": ["../compose.yaml"],
  "name": "Symfony app",
  "service": "php-cli",
  "remoteUser": "php-user",
  "workspaceFolder": "/app",
  "customizations": {
    "vscode": {
      "extensions": [
        "bmewburn.vscode-intelephense-client",
        "eamodio.gitlens",
        "ms-azuretools.vscode-docker",
        "recca0120.vscode-phpunit",
        "redhat.vscode-yaml",
        "streetsidesoftware.code-spell-checker",
        "yzhang.markdown-all-in-one"
      ]
    }
  }
}
              </code></pre>
              <legend>Configure DevContainers</legend>
            </div>

            <aside class="notes">
              <p>Provide the DevContainers file</p>
              <p>Another great thing of VS Code: sharing configuration through the workspace</p>
            </aside>
          </section>

          <section>
            <h2>Run tests without any PHP local installation</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">Configure PHPUnit in your IDE</li>
                <br />
                <li class="fragment practice-constraint" data-fragment-index="2">Add PHPUnit to the app</li>
                <li class="fragment practice-constraint" data-fragment-index="3">No local PHP, only Docker Compose</li>
                <br />
                <li class="fragment practice-success" data-fragment-index="4">Run a test with Docker</li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="5">Tips</div>
              <ul class="fragment" data-fragment-index="5">
                <li><code class="inline-code">composer req --dev phpunit/phpunit</code></li>
              </ul>
            </div>

            <aside class="notes">
              <p>Provide the test file</p>
            </aside>
          </section>

          <section>
            <h2>Debugging without any PHP local installation</h2>

            <div class="centered-slide-content">
              <ul>
                <li class="fragment practice-goal" data-fragment-index="1">
                  Add XDebug to the <code class="inline-code">dev</code> target
                </li>
                <li class="fragment practice-success" data-fragment-index="2">Debug the PHPUnit test</li>
              </ul>

              <br />
              <br />

              <div class="fragment" data-fragment-index="3">Tips</div>
              <ul class="fragment" data-fragment-index="3">
                <li><code class="inline-code">apt install php8.2-xdebug</code></li>
              </ul>
            </div>

            <aside class="notes">
              <p>Provide the xdebug.ini file</p>
            </aside>
          </section>

          <section>
            <h2>Debugging without any PHP local installation</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <pre class="fragment"><code class="dockerfile" data-trim data-line-numbers="2,7-8">
RUN apt-get update && \
    apt-get --yes install git php8.2-xdebug unzip && \
    apt-get clean && \
    apt-get --yes autoremove --purge && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

COPY docker/php/xdebug.ini /etc/php/8.2/cli/conf.d/99-xdebug.ini
COPY docker/php/xdebug.ini /etc/php/8.2/fpm/conf.d/99-xdebug.ini

COPY --from=composer:latest /usr/bin/composer /usr/local/bin/composer
RUN chmod +x /usr/local/bin/composer

RUN useradd php-user --shell /bin/bash --create-home \
  && usermod --append --groups sudo php-user \
  && echo 'ALL ALL = (ALL) NOPASSWD: ALL' >> /etc/sudoers \
  && echo 'php-user:secret' | chpasswd
              </code></pre>
            </div>

            <aside class="notes">
              <p>Ideally, XDebug should be turned off and activated when needed</p>
            </aside>
          </section>

          <section>
            <h2>Debugging without any PHP local installation</h2>

            <div class="centered-slide-content">
              <h3>Solution</h3>

              <ul>
                <li class="fragment">PHPStorm: nothing more to do for a CLI usage</li>
                <br />
                <li class="fragment">
                  VS Code: need to create a <code class="inline-code">launch.json</code> file,<br />
                  then listen to XDebug
                </li>
              </ul>
            </div>

            <aside class="notes">
              <p>Ideally, XDebug should be turned off and activated when needed</p>
            </aside>
          </section>
        </section>
      </div>
    </div>
    <script type="module" src="/main.js"></script>
  </body>
</html>
